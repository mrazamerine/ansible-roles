# LetsEncrypt tasks - nginx.yml
---
- name: install required packages - letsencrypt-nginx
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - nginx
    - python-certbot-nginx

- name: create letsencrypt cert
  shell: "certbot --nginx certonly --agree-tos --quiet ansible_local[letsencrypt_fact_name]['certbot']['email'] {{ letsencrypt_email }} -d {{ letsencrypt_domain_name }} {{ letsencrypt_additional_domains }}"
  when:
    - ansible_local[letsencrypt_fact_name]['certificate']['installed'] != 'True'
    - letsencrypt_domain_name is defined

- name: create ssl config file
  template:
    src: ssl.conf.j2
    dest: "/etc/nginx/snippets//ssl-{{ letsencrypt_domain_name }}.conf"
    owner: root
    group: root
    mode: 0644

- name: copy nginx ssl-params config file
  copy:
    src: ssl-params.conf
    dest: /etc/nginx/snippets/ssl-params.conf
    owner: root
    group: root
    mode: 0644
